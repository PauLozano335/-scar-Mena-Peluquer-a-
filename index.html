<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ã“scar Mena | BarberÃ­a Vila-real</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --dorado: #c5a059; --negro: #121212; --gris: #1a1a1a; --blanco: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--negro); color: var(--blanco); margin: 0; padding: 0; scroll-behavior: smooth; text-align: center; overflow-x: hidden; }
        header { padding: 40px 15px 10px; }
        .logo-box h1 { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--dorado); margin: 0; text-transform: uppercase; letter-spacing: 3px; }
        .insta-link { display: inline-block; margin-top: 15px; color: var(--dorado); text-decoration: none; font-size: 0.9rem; border: 1px solid var(--dorado); padding: 8px 15px; border-radius: 20px; transition: 0.3s; }
        .insta-link:hover { background: var(--dorado); color: #000; }
        .reserva-container { padding: 20px 15px; width: 100%; }
        .btn-principal { background: var(--dorado); color: #000; padding: 18px 0; width: 100%; max-width: 350px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; letter-spacing: 2px; text-transform: uppercase; border-radius: 4px; box-shadow: 0 4px 10px rgba(197,160,89,0.2); font-family: 'Poppins', sans-serif; }
        #reserva-desplegable { display: none; width: 100%; max-width: 500px; margin: 15px auto; background: var(--gris); padding: 20px 15px; border: 1px solid var(--dorado); text-align: left; animation: fadeIn 0.4s; border-radius: 8px; }
        .month-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-btn { background: var(--dorado); border: none; color: #000; cursor: pointer; padding: 8px 12px; font-weight: bold; border-radius: 4px; font-size: 0.7rem; font-family: 'Poppins', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day { padding: 15px 2px; background: #222; text-align: center; cursor: pointer; font-size: 0.9rem; border-radius: 4px; transition: 0.2s; }
        .day.selected { background: var(--dorado); color: #000; font-weight: bold; }
        .day.disabled { opacity: 0.1; cursor: not-allowed; }
        .day-header { color: var(--dorado); font-weight: bold; text-align: center; font-size: 0.65rem; padding-bottom: 5px; }
        .hours-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 20px; }
        .hour-card { padding: 10px 2px; background: #111; border: 1px solid #333; text-align: center; cursor: pointer; font-size: 0.75rem; border-radius: 4px; transition: 0.2s; }
        .hour-card:hover:not(.ocupado) { border-color: var(--dorado); }
        .hour-card.ocupado { opacity: 0.25; cursor: not-allowed; text-decoration: line-through; }
        .hour-card.selected-hour { background: var(--dorado); color: #000; font-weight: bold; border-color: var(--dorado); }
        #bookingForm { display: none; margin-top: 25px; border-top: 1px solid #333; padding-top: 20px; }
        .srv-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 15px; }
        .srv-item { background: #111; padding: 12px; border: 1px solid #333; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-radius: 4px; cursor: pointer; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; border: 1px solid #333; color: #fff; font-size: 16px; border-radius: 4px; font-family: 'Poppins', sans-serif; }
        .success-banner { display: none; background: #1a2e1a; border: 1px solid #4caf50; color: #4caf50; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; text-align: center; line-height: 1.6; }
        .galeria-titulo { margin-top: 40px; color: var(--dorado); font-family: 'Playfair Display', serif; font-size: 1.5rem; letter-spacing: 2px; }
        .galeria { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 20px 10px; max-width: 900px; margin: auto; }
        .galeria img { width: 100%; height: 200px; object-fit: cover; border-radius: 6px; border: 1px solid #333; transition: 0.3s; cursor: zoom-in; }
        .galeria img:hover { border-color: var(--dorado); transform: scale(1.02); }
        #imgModal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 85%; border: 2px solid var(--dorado); border-radius: 4px; }
        .close-modal { position: absolute; top: 20px; right: 25px; color: var(--blanco); font-size: 40px; cursor: pointer; }
        .mapa-seccion { padding: 40px 15px; background: #000; }
        .map-container { width: 100%; max-width: 800px; margin: auto; border: 1px solid var(--dorado); height: 300px; border-radius: 8px; overflow: hidden; }
        .map-container iframe { width: 100%; height: 100%; border: none; }
        footer { padding: 40px 15px; opacity: 0.6; font-size: 0.8rem; border-top: 1px solid #222; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="logo-box">
        <h1>Ã“scar Mena</h1>
        <p style="font-size:0.8rem; letter-spacing:4px; margin-top:5px;">VILA-REAL</p>
    </div>
    <a href="https://instagram.com/barber_mena_marcando_estilo" target="_blank" class="insta-link">
        ðŸ“· @barber_mena_marcando_estilo
    </a>
</header>

<section class="reserva-container">
    <button class="btn-principal" id="btnReservar">RESERVAR CITA</button>
    <div id="reserva-desplegable">
        <div class="month-controls">
            <button class="month-btn" id="btnAnt">ANT.</button>
            <h3 id="monthDisplay" style="margin:0; color:var(--dorado); font-family:'Playfair Display'; font-size:1rem;"></h3>
            <button class="month-btn" id="btnSig">SIG.</button>
        </div>
        <div class="calendar-grid" id="daysGrid"></div>
        <div id="hoursPanel" style="display:none; margin-top:30px;">
            <h4 id="selectedDateText" style="color:var(--dorado); margin-bottom:15px; font-size:0.9rem; border-bottom:1px solid #333; padding-bottom:10px;"></h4>
            <div id="hoursGrid" class="hours-grid"></div>
        </div>
        <div id="bookingForm">
            <h4 style="margin-top:0; font-size:1rem;">Servicios:</h4>
            <div class="srv-grid">
                <label class="srv-item"><input type="checkbox" class="srv" value="Corte" data-time="20"> Corte (20')</label>
                <label class="srv-item"><input type="checkbox" class="srv" value="Barba" data-time="10"> Barba (10')</label>
                <label class="srv-item"><input type="checkbox" class="srv" value="Cejas" data-time="5"> Cejas (5')</label>
                <label class="srv-item"><input type="checkbox" class="srv" value="Tinte" data-time="40"> Tinte (40')</label>
            </div>
            <p id="totalInfo" style="font-size:0.9rem; color:var(--dorado); font-weight:bold;"></p>
            <input type="text" id="clientName" placeholder="Tu nombre">
            <input type="tel" id="clientPhone" placeholder="Tu telÃ©fono">
            <button class="btn-principal" style="width:100%;" id="btnConfirmar">CONFIRMAR RESERVA</button>
        </div>
        <div class="success-banner" id="successBanner"></div>
    </div>
</section>

<h2 class="galeria-titulo">NUESTRO TRABAJO</h2>
<section class="galeria">
    <img src="https://i.ibb.co/ccw9FbwQ/Imagen1.jpg" onclick="expandImg(this.src)" alt="Corte 1">
    <img src="https://i.ibb.co/hxKzfRGH/Imagen2.jpg" onclick="expandImg(this.src)" alt="Corte 2">
    <img src="https://i.ibb.co/0p3PQhGh/Imagen3.jpg" onclick="expandImg(this.src)" alt="Corte 3">
    <img src="https://i.ibb.co/99vHQKd6/Imagen4.jpg" onclick="expandImg(this.src)" alt="Corte 4">
    <img src="https://i.ibb.co/84nRjWdn/Imagen1.jpg" onclick="expandImg(this.src)" alt="Corte 5">
    <img src="https://i.ibb.co/cS2mx6mn/Imagen2.jpg" onclick="expandImg(this.src)" alt="Corte 6">
    <img src="https://i.ibb.co/6RnzZKRT/Imagen3.jpg" onclick="expandImg(this.src)" alt="Corte 7">
    <img src="https://i.ibb.co/n245SQJ/Imagen4.jpg" onclick="expandImg(this.src)" alt="Corte 8">
</section>

<div id="imgModal" onclick="this.style.display='none'">
    <span class="close-modal">Ã—</span>
    <img id="imgFull" src="">
</div>

<section class="mapa-seccion">
    <h2 style="font-family:'Playfair Display'; color:var(--dorado); font-size:1.5rem;">UBICACIÃ“N</h2>
    <p style="font-size:0.9rem; margin-bottom:20px;">Carrer Borriol, 71, Vila-real</p>
    <div class="map-container">
        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3056.74127025816!2d-0.10174!3d39.9366!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd601894d0000001%3A0x0!2zMzlCsjU2JzExLjgiTiAwwrAwNicwNi4zIlc!5e0!3m2!1ses!2ses!4v1700000000000" loading="lazy"></iframe>
    </div>
</section>

<footer>
    <p>Ã“scar Mena Marcando Estilo</p>
</footer>

<!-- Todo en UN SOLO script type="module" para evitar problemas de timing -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBNdqm5xgjgsoEvc1gQw0fVuFyGr2uhDmE",
        authDomain: "oscar-mena-peluqueria.firebaseapp.com",
        databaseURL: "https://oscar-mena-peluqueria-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "oscar-mena-peluqueria",
        storageBucket: "oscar-mena-peluqueria.firebasestorage.app",
        messagingSenderId: "662914229809",
        appId: "1:662914229809:web:62daea4918d708cd201710"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentDate = new Date();
    let currentDay, currentMonth, currentYear, currentDow, selectedStartHour;
    let bookedSlots = {};

    // â”€â”€ Helpers Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadBookedSlots() {
        bookedSlots = {};
        try {
            const snap = await get(ref(db, 'reservas'));
            if (snap.exists()) {
                snap.forEach(child => {
                    const b = child.val();
                    if (b.estado === 'cancelada') return;
                    if (!bookedSlots[b.dateKey]) bookedSlots[b.dateKey] = [];
                    getSlotsForBooking(b.hora, b.duracion).forEach(s => {
                        if (!bookedSlots[b.dateKey].includes(s)) bookedSlots[b.dateKey].push(s);
                    });
                });
            }
        } catch(e) { console.error('Error cargando slots:', e); }
    }

    function getSlotsForBooking(startHour, duracion) {
        const [h, m] = startHour.split(':').map(Number);
        let sm = h * 60 + m, slots = [];
        for (let i = 0; i < duracion; i += 15) {
            let mm = sm + i;
            slots.push(`${Math.floor(mm/60)}:${(mm%60).toString().padStart(2,'0')}`);
        }
        return slots;
    }

    function generateSlots(dow) {
        let slots = [];
        const ranges = (dow === 6) ? [{s:10,e:14}] : [{s:10,e:13.5},{s:17,e:19.5}];
        ranges.forEach(r => {
            for (let m = r.s*60; m < r.e*60; m+=15)
                slots.push(`${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}`);
        });
        return slots;
    }

    // â”€â”€ Calendario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCalendar() {
        const grid = document.getElementById('daysGrid');
        grid.innerHTML = ['L','M','X','J','V','S','D'].map(d=>`<div class="day-header">${d}</div>`).join('');
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const first = new Date(y,m,1).getDay();
        const days  = new Date(y,m+1,0).getDate();
        const start = first === 0 ? 7 : first;
        document.getElementById('monthDisplay').innerText =
            new Intl.DateTimeFormat('es-ES',{month:'long',year:'numeric'}).format(currentDate).toUpperCase();
        for (let i=1; i<start; i++) grid.appendChild(document.createElement('div'));
        for (let d=1; d<=days; d++) {
            const div = document.createElement('div');
            div.className = 'day';
            const dow = new Date(y,m,d).getDay();
            if (dow===0||dow===1) div.classList.add('disabled');
            else div.addEventListener('click', () => selectDay(d,m,y,dow,div));
            div.innerText = d;
            grid.appendChild(div);
        }
    }

    function selectDay(d,m,y,dow,el) {
        document.querySelectorAll('.day').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        currentDay=d; currentMonth=m; currentYear=y; currentDow=dow;
        document.getElementById('hoursPanel').style.display = 'block';
        document.getElementById('bookingForm').style.display = 'none';
        document.getElementById('successBanner').style.display = 'none';
        document.getElementById('selectedDateText').innerText = `DÃA ${d}`;
        renderHours();
    }

    function renderHours() {
        const grid = document.getElementById('hoursGrid');
        grid.innerHTML = '';
        const dateKey = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;
        const occupied = bookedSlots[dateKey] || [];
        generateSlots(currentDow).forEach(slot => {
            const card = document.createElement('div');
            card.className = 'hour-card';
            card.innerText = slot;
            if (occupied.includes(slot)) {
                card.classList.add('ocupado');
            } else {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.hour-card').forEach(c=>c.classList.remove('selected-hour'));
                    card.classList.add('selected-hour');
                    selectedStartHour = slot;
                    document.getElementById('bookingForm').style.display = 'block';
                    document.getElementById('successBanner').style.display = 'none';
                });
            }
            grid.appendChild(card);
        });
    }

    function actualizarTiempos() {
        let total = 0;
        document.querySelectorAll('.srv:checked').forEach(s => total += parseInt(s.dataset.time));
        document.getElementById('totalInfo').innerText = total > 0 ? `DURACIÃ“N: ${total} MIN` : '';
    }

    async function saveBooking() {
        const name  = document.getElementById('clientName').value.trim();
        const phone = document.getElementById('clientPhone').value.trim();
        const checks = document.querySelectorAll('.srv:checked');
        if (!name || !phone || checks.length===0) return alert("Rellena tu nombre, telÃ©fono y selecciona al menos un servicio.");
        if (!selectedStartHour) return alert("Selecciona una hora.");

        let servicios = [], duracionTotal = 0;
        checks.forEach(c => { servicios.push(c.value); duracionTotal += parseInt(c.dataset.time); });
        duracionTotal = Math.ceil(duracionTotal/15)*15;

        const dateKey = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;

        const booking = {
            nombre: name, telefono: phone,
            fecha: `${currentDay}/${currentMonth+1}/${currentYear}`,
            dateKey, hora: selectedStartHour,
            servicios: servicios.join(', '),
            duracion: duracionTotal,
            estado: 'pendiente',
            createdAt: new Date().toISOString()
        };

        const btn = document.getElementById('btnConfirmar');
        btn.disabled = true;
        btn.innerText = 'Guardandoâ€¦';

        try {
            await push(ref(db, 'reservas'), booking);

            document.getElementById('bookingForm').style.display = 'none';
            const banner = document.getElementById('successBanner');
            banner.style.display = 'block';
            banner.innerHTML = `âœ… Â¡Reserva confirmada!<br><strong>${name}</strong> â€” ${currentDay}/${currentMonth+1}/${currentYear} a las <strong>${selectedStartHour}</strong>`;

            await loadBookedSlots();
            renderHours();
        } catch(e) {
            console.error(e);
            alert("Error al guardar. Comprueba tu conexiÃ³n e intÃ©ntalo de nuevo.");
        } finally {
            btn.disabled = false;
            btn.innerText = 'CONFIRMAR RESERVA';
        }
    }

    // â”€â”€ GalerÃ­a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.expandImg = function(src) {
        document.getElementById('imgFull').src = src;
        document.getElementById('imgModal').style.display = 'flex';
    };

    // â”€â”€ Eventos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btnReservar').addEventListener('click', async () => {
        const div = document.getElementById('reserva-desplegable');
        const open = div.style.display === 'block';
        div.style.display = open ? 'none' : 'block';
        if (!open) {
            await loadBookedSlots();
            renderCalendar();
        }
    });

    document.getElementById('btnAnt').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth()-1); renderCalendar();
    });
    document.getElementById('btnSig').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth()+1); renderCalendar();
    });
    document.getElementById('btnConfirmar').addEventListener('click', saveBooking);
    document.querySelectorAll('.srv').forEach(cb => cb.addEventListener('change', actualizarTiempos));

</script>
</body>
</html>
